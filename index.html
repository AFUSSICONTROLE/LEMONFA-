<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEMONFA AFUSSI - Le G√©nie B√©ninois</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.1); }
        .photo-frame { width: 120px; height: 120px; border-radius: 20px; object-fit: cover; border: 3px solid #3b82f6; box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
        .locked { filter: blur(30px); pointer-events: none; opacity: 0.2; }
        .genie-border { border: 2px solid transparent; background: linear-gradient(black, black) padding-box, linear-gradient(45deg, #f97316, #3b82f6) border-box; }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
        .scanner::after { content: ""; position: absolute; width: 100%; height: 2px; background: #3b82f6; top: 0; left: 0; animation: scan 2s infinite linear; box-shadow: 0 0 15px #3b82f6; }
    </style>
</head>
<body id="main-body" class="bg-[#020202] text-white min-h-screen font-sans selection:bg-blue-500">

    <div id="config-screen" class="fixed inset-0 z-[100] bg-black/90 flex flex-col items-center justify-center p-8 text-center hidden">
        <div class="w-16 h-16 bg-blue-600 rounded-full mb-4 flex items-center justify-center text-2xl">‚öôÔ∏è</div>
        <h2 class="text-xl font-bold mb-4 uppercase">Lien Firebase</h2>
        <input type="text" id="fb-url" placeholder="https://..." class="w-full p-4 rounded-2xl bg-zinc-900 border border-zinc-800 mb-4 outline-none">
        <div class="flex gap-2 w-full">
            <button onclick="saveConfig()" class="flex-1 bg-blue-600 py-4 rounded-2xl font-black">SAUVEGARDER</button>
            <button onclick="document.getElementById('config-screen').classList.add('hidden')" class="flex-1 bg-zinc-800 py-4 rounded-2xl font-black">IGNORER</button>
        </div>
    </div>

    <div id="lock-screen" class="fixed inset-0 z-50 bg-black flex flex-col items-center p-6 overflow-y-auto">
        <div class="mt-8 mb-10 text-center">
            <div class="relative inline-block p-1 rounded-full genie-border mb-4">
                <img id="genie-photo" src="https://via.placeholder.com/80" class="w-20 h-20 rounded-full object-cover">
            </div>
            <h1 class="text-orange-500 font-black text-xl tracking-tighter">LEMONFA AFUSSI</h1>
            <p class="text-[9px] text-zinc-500 uppercase tracking-[0.3em] font-bold italic">Le G√©nie B√©ninois</p>
        </div>

        <button id="install-btn" class="hidden mb-6 bg-white text-black px-6 py-2 rounded-full font-bold text-xs animate-bounce">
            INSTALLER L'APPLICATION üì≤
        </button>

        <h2 class="text-2xl font-light mb-12 text-center">Signature <span class="text-blue-500 font-bold">Obligatoire</span></h2>
        
        <div class="flex justify-around w-full max-w-md mb-12 gap-4">
            <div class="flex flex-col items-center">
                <div class="relative scanner overflow-hidden rounded-2xl">
                    <img id="view-locat" src="https://via.placeholder.com/150" class="photo-frame border-zinc-800">
                </div>
                <p id="name-locat-label" class="text-[11px] mt-3 font-black text-blue-400">LOCATAIRE</p>
                <button onclick="auth('locat')" id="btn-l" class="mt-4 bg-zinc-900 border border-zinc-800 px-6 py-3 rounded-xl text-[10px] font-bold">SIGNER</button>
            </div>

            <div class="flex flex-col items-center">
                <div class="relative scanner overflow-hidden rounded-2xl">
                    <img id="view-proprio" src="https://via.placeholder.com/150" class="photo-frame border-zinc-800">
                </div>
                <p id="name-proprio-label" class="text-[11px] mt-3 font-black text-orange-500">PROPRI√âTAIRE</p>
                <button onclick="auth('proprio')" id="btn-p" class="mt-4 bg-zinc-900 border border-zinc-800 px-6 py-3 rounded-xl text-[10px] font-bold">SIGNER</button>
            </div>
        </div>
        <p id="ia-date" class="text-[10px] font-mono text-zinc-600 mt-auto mb-4"></p>
    </div>

    <main id="main-content" class="locked p-6 max-w-md mx-auto">
        <header class="flex justify-between items-end mb-10">
            <div>
                <p class="text-[10px] text-blue-500 font-black">JUSTICE √âNERG√âTIQUE</p>
                <h1 class="text-2xl font-black leading-none uppercase">LEMONFA <span class="text-orange-500 italic">Afussi</span></h1>
            </div>
            <button onclick="document.getElementById('config-screen').classList.remove('hidden')" class="bg-zinc-900 p-2 rounded-xl text-[18px]">‚öôÔ∏è</button>
        </header>

        <div class="glass p-10 rounded-[3rem] text-center shadow-2xl mb-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-500 to-blue-500"></div>
            <p class="text-zinc-500 text-[10px] font-black uppercase mb-4 tracking-widest">Montant √† payer</p>
            <h2 id="solde-argent" class="text-6xl font-black mb-2 tracking-tighter italic">0 FCFA</h2>
            <div class="inline-block px-4 py-1 bg-zinc-900 rounded-full border border-zinc-800">
                <span id="solde-kwh" class="text-blue-400 font-mono text-xs font-bold">0.00 kWh</span>
            </div>
        </div>

        <div class="grid grid-cols-1 gap-4">
            <button onclick="validerPaiement()" class="bg-white text-black p-6 rounded-[2rem] font-black flex justify-between items-center group active:scale-95 transition">
                <span class="text-sm uppercase">Recharger Cr√©dit</span>
                <span class="bg-black text-white w-10 h-10 rounded-full flex items-center justify-center">‚ö°</span>
            </button>

            <div class="glass p-6 rounded-[2rem] border border-zinc-800">
                <p class="text-[9px] text-zinc-600 mb-4 uppercase font-bold text-center">Enregistrement des parties</p>
                <div class="flex gap-2">
                    <button onclick="updateIdentity('proprio')" class="flex-1 bg-orange-600/10 p-4 rounded-2xl text-[9px] font-black border border-orange-500/20">PROPRI√âTAIRE</button>
                    <button onclick="updateIdentity('locat')" class="flex-1 bg-blue-600/10 p-4 rounded-2xl text-[9px] font-black border border-blue-500/20">LOCATAIRE</button>
                </div>
            </div>
        </div>
        <input type="file" id="fileIn" class="hidden" accept="image/*">
    </main>

    <script>
        const pins = { proprio: "2026", locat: "1234" };
        let authStates = { proprio: false, locat: false };
        let db;
        let deferredPrompt;

        function speak(t) { window.speechSynthesis.cancel(); let m = new SpeechSynthesisUtterance(t); m.lang='fr-FR'; m.rate=0.9; window.speechSynthesis.speak(m); }

        // GESTION INSTALLATION
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-btn').classList.remove('hidden');
        });

        document.getElementById('install-btn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') document.getElementById('install-btn').classList.add('hidden');
                deferredPrompt = null;
            }
        });

        function saveConfig() {
            const u = document.getElementById('fb-url').value;
            if(u.includes("firebaseio.com")) { 
                localStorage.setItem('fb_url', u); 
                location.reload(); 
            }
        }

        window.onload = () => {
            const url = localStorage.getItem('fb_url');
            if(url) {
                firebase.initializeApp({ databaseURL: url });
                db = firebase.database();
                syncFirebase();
            }
            
            const now = new Date();
            document.getElementById('ia-date').innerText = now.toLocaleString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
            loadProfiles();
            
            setTimeout(() => {
                speak(`Salutations. Je suis l'intelligence artificielle du syst√®me con√ßu par LE G√âNIE B√âNINOIS, Monsieur LEMONFA AFUSSI. Cette technologie assure une justice totale. Veuillez signer.`);
                if(!url) speak("Note : La base de donn√©es n'est pas configur√©e, mais vous pouvez tester l'interface.");
            }, 1000);
        };

        function auth(user) {
            let p = prompt(`PIN ${user === 'proprio' ? 'PROPRI√âTAIRE' : 'LOCATAIRE'} :`);
            if(p === pins[user]) {
                authStates[user] = true;
                document.getElementById(`btn-${user === 'proprio' ? 'p' : 'l'}`).innerText = "SIGN√â ‚úì";
                document.getElementById(`btn-${user === 'proprio' ? 'p' : 'l'}`).classList.add('bg-green-600/20', 'text-green-500');
                if(authStates.proprio && authStates.locat) unlock();
            }
        }

        function unlock() {
            document.getElementById('lock-screen').style.transform = "translateY(-100%)";
            document.getElementById('lock-screen').style.transition = "0.8s ease-in";
            setTimeout(() => {
                document.getElementById('lock-screen').classList.add('hidden');
                document.getElementById('main-content').classList.remove('locked');
            }, 800);
            speak("Acc√®s accord√©. Justice est faite.");
        }

        function syncFirebase() {
            if(!db) return;
            db.ref('systeme').on('value', (s) => {
                const d = s.val();
                if(!d) return;
                document.getElementById('solde-kwh').innerText = d.solde_kwh.toFixed(2) + " kWh";
                document.getElementById('solde-argent').innerText = Math.floor(d.solde_kwh * 125) + " FCFA";
                if(d.alerte_vol) {
                    document.body.style.background = "#300";
                    speak("ALERTE ! Une anomalie est d√©tect√©e sur le compteur !");
                }
            });
        }

        function updateIdentity(user) {
            let n = prompt("Entrez le Nom :");
            if(n) {
                localStorage.setItem(`name-${user}`, n);
                document.getElementById('fileIn').onchange = (e) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        localStorage.setItem(`photo-${user}`, reader.result);
                        loadProfiles();
                    };
                    reader.readAsDataURL(e.target.files[0]);
                };
                document.getElementById('fileIn').click();
            }
        }

        function loadProfiles() {
            ['proprio', 'locat'].forEach(u => {
                let p = localStorage.getItem(`photo-${u}`);
                let n = localStorage.getItem(`name-${u}`);
                if(p) {
                    document.getElementById(`view-${u}`).src = p;
                    if(u === 'proprio') document.getElementById('genie-photo').src = p;
                }
                if(n) document.getElementById(`name-${u}-label`).innerText = n.toUpperCase();
            });
        }

        function validerPaiement() {
            if(!db) { alert("Configurez Firebase d'abord !"); return; }
            let m = prompt("Montant (FCFA) :");
            if(m && !isNaN(m)) {
                db.ref('systeme').update({ recharge_temp: parseFloat(m)/125 });
                speak("Recharge transmise au syst√®me.");
            }
        }
    </script>
</body>
</html>
