<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEMONFA Afussi - Le Génie Béninois</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.1); }
        .photo-frame { width: 120px; height: 120px; border-radius: 20px; object-fit: cover; border: 3px solid #3b82f6; background: #111; }
        .locked { filter: blur(35px); pointer-events: none; opacity: 0.1; transition: 0.8s; }
        .genie-border { border: 2px solid transparent; background: linear-gradient(black, black) padding-box, linear-gradient(45deg, #f97316, #3b82f6) border-box; }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
        .scanner::after { content: ""; position: absolute; width: 100%; height: 2px; background: #3b82f6; top: 0; left: 0; animation: scan 2s infinite linear; box-shadow: 0 0 15px #3b82f6; }
        ::-webkit-scrollbar { width: 0px; }
    </style>
</head>
<body id="main-body" class="bg-[#020202] text-white min-h-screen font-sans">

    <div id="config-screen" class="fixed inset-0 z-[100] bg-black/95 flex flex-col items-center justify-center p-8 text-center hidden">
        <h2 class="text-xl font-bold mb-6 uppercase tracking-widest text-blue-500">Paramètres Système</h2>
        <div class="space-y-4 w-full max-w-xs">
            <input type="text" id="fb-url" placeholder="Lien Firebase" class="w-full p-4 rounded-xl bg-zinc-900 border border-zinc-800 outline-none text-xs">
            <div class="grid grid-cols-2 gap-2">
                <input type="password" id="new-pin-p" placeholder="PIN Proprio" class="p-4 rounded-xl bg-zinc-900 border border-zinc-800 text-xs text-center">
                <input type="password" id="new-pin-l" placeholder="PIN Locat" class="p-4 rounded-xl bg-zinc-900 border border-zinc-800 text-xs text-center">
            </div>
            <button onclick="saveGlobalConfig()" class="w-full bg-blue-600 py-4 rounded-xl font-black">APPLIQUER</button>
            <button onclick="document.getElementById('config-screen').classList.add('hidden')" class="w-full bg-zinc-800 py-4 rounded-xl">RETOUR</button>
        </div>
    </div>

    <div id="lock-screen" class="fixed inset-0 z-50 bg-black flex flex-col items-center p-6 overflow-y-auto transition-transform duration-700">
        <div class="mt-8 mb-10 text-center">
            <div class="relative inline-block p-1 rounded-full genie-border mb-4">
                <img id="genie-photo" src="icon.png" class="w-20 h-20 rounded-full object-cover" onerror="this.src='https://via.placeholder.com/80'">
            </div>
            <h1 class="text-orange-500 font-black text-xl uppercase italic">Lemonfa Afussi</h1>
            <p class="text-[10px] text-zinc-500 uppercase tracking-[0.3em] font-bold">Le Génie Béninois</p>
        </div>

        <h2 class="text-2xl font-light mb-12 text-center uppercase tracking-widest">Signature <span class="text-blue-500 font-bold italic">Double</span></h2>
        
        <div class="flex justify-around w-full max-w-md mb-12 gap-4">
            <div class="flex flex-col items-center">
                <div class="relative scanner overflow-hidden rounded-2xl bg-zinc-900">
                    <img id="view-locat" src="https://via.placeholder.com/512" class="photo-frame">
                </div>
                <p id="name-locat-label" class="text-[10px] mt-3 font-black text-blue-400">LOCATAIRE</p>
                <button onclick="auth('locat')" id="btn-l" class="mt-4 bg-zinc-900 border border-zinc-800 px-6 py-3 rounded-xl text-[10px] font-black uppercase">Signer</button>
            </div>

            <div class="flex flex-col items-center">
                <div class="relative scanner overflow-hidden rounded-2xl bg-zinc-900">
                    <img id="view-proprio" src="https://via.placeholder.com/512" class="photo-frame">
                </div>
                <p id="name-proprio-label" class="text-[10px] mt-3 font-black text-orange-500">PROPRIÉTAIRE</p>
                <button onclick="auth('proprio')" id="btn-p" class="mt-4 bg-zinc-900 border border-zinc-800 px-6 py-3 rounded-xl text-[10px] font-black uppercase">Signer</button>
            </div>
        </div>
        <p id="ia-date" class="text-[10px] font-mono text-zinc-600 mt-auto mb-4 uppercase"></p>
    </div>

    <main id="main-content" class="locked p-6 max-w-md mx-auto">
        <header class="flex justify-between items-center mb-8">
            <div>
                <p class="text-[10px] text-blue-500 font-black italic tracking-widest">MADE IN BÉNIN</p>
                <h1 class="text-2xl font-black uppercase tracking-tighter">LEMONFA AFUSSI</h1>
            </div>
            <button onclick="document.getElementById('config-screen').classList.remove('hidden')" class="bg-zinc-900 p-3 rounded-xl">⚙️</button>
        </header>

        <div class="glass p-8 rounded-[2.5rem] text-center mb-6 relative overflow-hidden">
            <div id="status-bar" class="absolute top-0 left-0 w-full h-1 bg-blue-500"></div>
            <p id="display-price-info" class="text-[10px] text-zinc-500 uppercase font-black mb-2 italic">Chargement du tarif...</p>
            <h2 id="solde-argent" class="text-5xl font-black mb-2 tracking-tighter">0 FCFA</h2>
            <div class="inline-block px-4 py-1 bg-black/40 rounded-full border border-white/5">
                <span id="solde-kwh" class="text-blue-400 font-mono text-xs font-bold">0.00 kWh</span>
            </div>
        </div>

        <div class="grid grid-cols-1 gap-3 mb-6">
            <button onclick="validerPaiement()" class="bg-white text-black p-5 rounded-3xl font-black flex justify-between items-center active:scale-95 transition">
                <span class="text-xs uppercase tracking-widest">Recharger Crédit</span>
                <span class="bg-black text-white w-8 h-8 rounded-full flex items-center justify-center text-xs">⚡</span>
            </button>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="updateIdentityUI()" class="bg-zinc-900 p-5 rounded-3xl text-[10px] font-black border border-zinc-800 uppercase">Configuration Photos</button>
                <button onclick="setUnitPrice()" class="bg-zinc-900 p-5 rounded-3xl text-[10px] font-black border border-zinc-800 uppercase text-orange-500">Prix Unitaire</button>
            </div>
        </div>

        <div class="glass p-6 rounded-[2rem] border border-white/5">
            <div class="flex justify-between items-center mb-4">
                <p class="text-[10px] font-black text-zinc-400 uppercase tracking-widest italic">Registre de Justice</p>
                <button onclick="clearHistory()" class="text-[9px] text-red-500 font-bold uppercase">Nettoyer</button>
            </div>
            <div id="history-list" class="space-y-3 max-h-48 overflow-y-auto pr-2 text-[10px]">
                <p class="text-zinc-600 italic">Historique mémorisé vide.</p>
            </div>
        </div>

        <input type="file" id="fileIn" class="hidden" accept="image/*">
        <canvas id="canvasResize" width="512" height="512" class="hidden"></canvas>
    </main>

    <script>
        let pins = {
            proprio: localStorage.getItem('pin_proprio') || "2026",
            locat: localStorage.getItem('pin_locat') || "1234"
        };
        let authStates = { proprio: false, locat: false };
        let unitPrice = parseFloat(localStorage.getItem('unit_price')) || 125;
        let db;

        function speak(t) { 
            window.speechSynthesis.cancel(); 
            let m = new SpeechSynthesisUtterance(t); 
            m.lang='fr-FR'; m.rate=0.92; m.pitch=1.1; 
            window.speechSynthesis.speak(m); 
        }

        window.onload = () => {
            const url = localStorage.getItem('fb_url');
            if(url) {
                firebase.initializeApp({ databaseURL: url });
                db = firebase.database();
                syncFirebase();
            }
            document.getElementById('ia-date').innerText = new Date().toLocaleString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            loadProfiles();
            updateHistoryUI();
            updatePriceDisplay();
            setTimeout(() => speak("Salutations. Je suis l'intelligence artificielle du système de justice énergétique, une innovation Made in Bénin, conçue par le génie caché, Monsieur Lemonfa Afussi. Identifiez-vous pour continuer."), 1000);
        };

        function saveGlobalConfig() {
            const u = document.getElementById('fb-url').value;
            const np = document.getElementById('new-pin-p').value;
            const nl = document.getElementById('new-pin-l').value;
            if(u) localStorage.setItem('fb_url', u);
            if(np) localStorage.setItem('pin_proprio', np);
            if(nl) localStorage.setItem('pin_locat', nl);
            speak("Paramètres mémorisés avec succès par le génie.");
            setTimeout(() => location.reload(), 1500);
        }

        function auth(user) {
            let p = prompt(`CODE PIN ${user.toUpperCase()} :`);
            if(p === pins[user]) {
                authStates[user] = true;
                document.getElementById(`btn-${user === 'proprio' ? 'p' : 'l'}`).innerText = "ACCEPTÉ✓";
                document.getElementById(`btn-${user === 'proprio' ? 'p' : 'l'}`).style.background = "#052";
                speak(`Signature du ${user === 'proprio' ? 'propriétaire' : 'locataire'} validée.`);
                if(authStates.proprio && authStates.locat) unlock();
            } else { speak("Code de sécurité incorrect. Accès refusé."); }
        }

        function unlock() {
            document.getElementById('lock-screen').style.transform = "translateY(-100%)";
            setTimeout(() => {
                document.getElementById('lock-screen').classList.add('hidden');
                document.getElementById('main-content').classList.remove('locked');
            }, 800);
            speak("Les deux parties ont signé. Justice est faite. Bienvenue dans l'interface Lemonfa Afussi.");
        }

        function updateIdentityUI() {
            let user = prompt("Modifier PHOTO et NOM de qui ? (proprio / locat)").toLowerCase();
            if(user !== 'proprio' && user !== 'locat') return;

            if(prompt(`ENTREZ PIN ${user.toUpperCase()} :`) === pins[user]) {
                let n = prompt("Entrez le Nom complet :");
                if(n) {
                    localStorage.setItem(`name-${user}`, n);
                    const fileInput = document.getElementById('fileIn');
                    fileInput.onchange = (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const img = new Image();
                            img.onload = () => {
                                const canvas = document.getElementById('canvasResize');
                                const ctx = canvas.getContext('2d');
                                let side = Math.min(img.width, img.height);
                                ctx.drawImage(img, (img.width-side)/2, (img.height-side)/2, side, side, 0, 0, 512, 512);
                                localStorage.setItem(`photo-${user}`, canvas.toDataURL('image/jpeg', 0.7));
                                loadProfiles();
                                speak(`Identité du ${user} mise à jour et mémorisée.`);
                            };
                            img.src = event.target.result;
                        };
                        reader.readAsDataURL(file);
                    };
                    fileInput.click();
                }
            } else { speak("Modification non autorisée."); }
        }

        function setUnitPrice() {
            speak("Attention. Le changement de prix unitaire exige la présence et le consentement des deux parties.");
            let p1 = prompt("PIN PROPRIÉTAIRE :");
            let p2 = prompt("PIN LOCATAIRE :");
            if(p1 === pins.proprio && p2 === pins.locat) {
                let nouveauPrix = prompt("Nouveau tarif unitaire (FCFA/kWh) :", unitPrice);
                if(nouveauPrix && !isNaN(nouveauPrix)) {
                    unitPrice = parseFloat(nouveauPrix);
                    localStorage.setItem('unit_price', unitPrice);
                    addToHistory(`TARIF CHANGÉ : ${unitPrice} FCFA/kWh`);
                    updatePriceDisplay();
                    speak(`Le nouveau tarif de ${unitPrice} francs cfa par kilowattheure est désormais appliqué.`);
                }
            } else { speak("Sécurité activée. Les deux codes sont obligatoires pour changer le prix."); }
        }

        function updatePriceDisplay() {
            document.getElementById('display-price-info').innerText = `PRIX UNITAIRE : ${unitPrice} FCFA / KWH`;
        }

        function syncFirebase() {
            if(!db) return;
            db.ref('systeme').on('value', (s) => {
                const d = s.val() || { solde_kwh: 0 };
                document.getElementById('solde-kwh').innerText = d.solde_kwh.toFixed(2) + " kWh";
                document.getElementById('solde-argent').innerText = Math.floor(d.solde_kwh * unitPrice) + " FCFA";
                if(d.alerte_vol) {
                    document.body.style.background = "#600";
                    speak("ALERTE CRITIQUE ! Une fraude ou un vol d'énergie est détecté sur votre ligne.");
                } else { document.body.style.background = "#020202"; }
            });
        }

        function validerPaiement() {
            if(prompt("PIN PROPRIÉTAIRE POUR RECHARGE :") === pins.proprio) {
                let m = prompt("Montant de la recharge (FCFA) :");
                if(m && !isNaN(m)) {
                    let kwh = parseFloat(m) / unitPrice;
                    db.ref('systeme').update({ recharge_temp: kwh });
                    addToHistory(`RECHARGE : +${m} FCFA (${kwh.toFixed(2)} kWh)`);
                    speak(`Recharge validée. Vous avez ajouté ${m} francs cfa, soit ${kwh.toFixed(2)} kilowattheures au compteur.`);
                }
            } else { speak("Code incorrect. Recharge annulée."); }
        }

        function addToHistory(msg) {
            let h = JSON.parse(localStorage.getItem('afussi_history') || "[]");
            h.unshift(`${new Date().toLocaleDateString('fr-FR')} à ${new Date().toLocaleTimeString('fr-FR')} : ${msg}`);
            localStorage.setItem('afussi_history', JSON.stringify(h.slice(0, 20)));
            updateHistoryUI();
        }

        function updateHistoryUI() {
            let h = JSON.parse(localStorage.getItem('afussi_history') || "[]");
            const list = document.getElementById('history-list');
            if(h.length > 0) {
                list.innerHTML = h.map(item => `<div class="bg-white/5 p-3 rounded-xl border-l-2 border-blue-500 mb-2">${item}</div>`).join('');
            }
        }

        function clearHistory() {
            speak("La suppression de l'historique nécessite les deux signatures.");
            if(prompt("PIN PROPRIO :") === pins.proprio && prompt("PIN LOCATAIRE :") === pins.locat) {
                localStorage.removeItem('afussi_history');
                updateHistoryUI();
                speak("L'historique des opérations a été effacé par consentement mutuel.");
            } else { speak("Action refusée. La présence des deux parties est obligatoire."); }
        }

        function loadProfiles() {
            ['proprio', 'locat'].forEach(u => {
                const p = localStorage.getItem(`photo-${u}`);
                const n = localStorage.getItem(`name-${u}`);
                if(p) document.getElementById(`view-${u}`).src = p;
                if(n) document.getElementById(`name-${u}-label`).innerText = n.toUpperCase();
                if(u === 'proprio' && p) document.getElementById('genie-photo').src = p;
            });
        }
    </script>
</body>
</html>
