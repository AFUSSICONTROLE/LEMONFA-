<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lemonfa Afussi - Le Génie Béninois</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.1); }
        .photo-frame { width: 130px; height: 130px; border-radius: 25px; object-fit: cover; border: 3px solid #3b82f6; background: #111; shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
        .locked { filter: blur(40px); pointer-events: none; opacity: 0.1; transition: 0.5s; }
        .genie-border { border: 2px solid transparent; background: linear-gradient(black, black) padding-box, linear-gradient(45deg, #f97316, #3b82f6) border-box; }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
        .scanner::after { content: ""; position: absolute; width: 100%; height: 3px; background: #3b82f6; top: 0; left: 0; animation: scan 2s infinite linear; box-shadow: 0 0 20px #3b82f6; }
    </style>
</head>
<body id="main-body" class="bg-[#020202] text-white min-h-screen font-sans overflow-x-hidden">

    <div id="config-screen" class="fixed inset-0 z-[100] bg-black/95 flex flex-col items-center justify-center p-8 text-center hidden">
        <div class="w-16 h-16 bg-blue-600 rounded-full mb-6 flex items-center justify-center text-3xl">⚙️</div>
        <h2 class="text-xl font-black mb-6 uppercase tracking-widest">Configuration Système</h2>
        <input type="text" id="fb-url" placeholder="Lien Firebase (https://...)" class="w-full p-5 rounded-2xl bg-zinc-900 border border-zinc-800 mb-6 outline-none font-mono text-sm">
        <div class="flex gap-4 w-full">
            <button onclick="saveConfig()" class="flex-1 bg-blue-600 py-5 rounded-2xl font-black text-sm">SAUVEGARDER</button>
            <button onclick="document.getElementById('config-screen').classList.add('hidden')" class="flex-1 bg-zinc-800 py-5 rounded-2xl font-black text-sm">FERMER</button>
        </div>
    </div>

    <div id="lock-screen" class="fixed inset-0 z-50 bg-black flex flex-col items-center p-6 overflow-y-auto transition-transform duration-700">
        <div class="mt-10 mb-12 text-center">
            <div class="relative inline-block p-1 rounded-full genie-border mb-4">
                <img id="genie-photo" src="icon.png" class="w-24 h-24 rounded-full object-cover" onerror="this.src='https://via.placeholder.com/100'">
            </div>
            <h1 class="text-orange-500 font-black text-2xl tracking-tighter uppercase">Lemonfa Afussi</h1>
            <p class="text-[10px] text-zinc-500 uppercase tracking-[0.4em] font-bold">Le Génie Béninois</p>
        </div>

        <h2 class="text-2xl font-light mb-10 text-center uppercase tracking-widest">Signature <span class="text-blue-500 font-black">Double</span></h2>
        
        <div class="flex justify-around w-full max-w-md mb-12 gap-6">
            <div class="flex flex-col items-center">
                <div class="relative scanner overflow-hidden rounded-[2rem] bg-zinc-900">
                    <img id="view-locat" src="https://via.placeholder.com/512" class="photo-frame">
                </div>
                <p id="name-locat-label" class="text-[11px] mt-4 font-black text-blue-400">LOCATAIRE</p>
                <button onclick="auth('locat')" id="btn-l" class="mt-4 bg-white/5 border border-white/10 px-8 py-4 rounded-2xl text-[11px] font-black uppercase">Signer</button>
            </div>

            <div class="flex flex-col items-center">
                <div class="relative scanner overflow-hidden rounded-[2rem] bg-zinc-900">
                    <img id="view-proprio" src="https://via.placeholder.com/512" class="photo-frame">
                </div>
                <p id="name-proprio-label" class="text-[11px] mt-4 font-black text-orange-500">PROPRIÉTAIRE</p>
                <button onclick="auth('proprio')" id="btn-p" class="mt-4 bg-white/5 border border-white/10 px-8 py-4 rounded-2xl text-[11px] font-black uppercase">Signer</button>
            </div>
        </div>
        <p id="ia-date" class="text-[10px] font-mono text-zinc-600 mt-auto mb-6 uppercase"></p>
    </div>

    <main id="main-content" class="locked p-6 max-w-md mx-auto">
        <header class="flex justify-between items-center mb-10">
            <div>
                <p class="text-[10px] text-blue-500 font-black tracking-widest uppercase">Justice Énergétique</p>
                <h1 class="text-2xl font-black uppercase">LEMONFA <span class="text-orange-500 italic">Afussi</span></h1>
            </div>
            <div class="flex gap-2">
                <button onclick="document.getElementById('config-screen').classList.remove('hidden')" class="bg-zinc-900 p-4 rounded-2xl text-xl">⚙️</button>
            </div>
        </header>

        <div class="glass p-12 rounded-[3.5rem] text-center shadow-2xl mb-10 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-orange-500 via-white to-blue-500"></div>
            <p class="text-zinc-500 text-[11px] font-black uppercase mb-6 tracking-[0.2em]">Consommation Actuelle</p>
            <h2 id="solde-argent" class="text-6xl font-black mb-4 tracking-tighter italic">0 FCFA</h2>
            <div class="inline-block px-6 py-2 bg-black/50 rounded-full border border-white/10">
                <span id="solde-kwh" class="text-blue-400 font-mono text-sm font-black">0.00 kWh</span>
            </div>
        </div>

        <div class="space-y-4">
            <button onclick="validerPaiement()" class="w-full bg-white text-black p-7 rounded-[2.5rem] font-black flex justify-between items-center active:scale-95 transition-all">
                <span class="text-sm uppercase tracking-widest">Recharger Crédit</span>
                <span class="bg-black text-white w-12 h-12 rounded-full flex items-center justify-center text-xl shadow-lg">⚡</span>
            </button>

            <div class="glass p-8 rounded-[2.5rem] border border-white/5">
                <p class="text-[10px] text-zinc-500 mb-6 uppercase font-black text-center tracking-widest">Gestion des Identités (512px)</p>
                <div class="flex gap-3">
                    <button onclick="updateIdentity('proprio')" class="flex-1 bg-orange-600/20 py-5 rounded-2xl text-[10px] font-black border border-orange-500/30 uppercase tracking-tighter">Photo Proprio</button>
                    <button onclick="updateIdentity('locat')" class="flex-1 bg-blue-600/20 py-5 rounded-2xl text-[10px] font-black border border-blue-500/30 uppercase tracking-tighter">Photo Locat</button>
                </div>
            </div>
        </div>
        
        <input type="file" id="fileIn" class="hidden" accept="image/*">
        <canvas id="canvas512" width="512" height="512" class="hidden"></canvas>
    </main>

    <script>
        const pins = { proprio: "2026", locat: "1234" };
        let authStates = { proprio: false, locat: false };
        let db;

        function speak(t) { window.speechSynthesis.cancel(); let m = new SpeechSynthesisUtterance(t); m.lang='fr-FR'; m.rate=0.95; window.speechSynthesis.speak(m); }

        function saveConfig() {
            const u = document.getElementById('fb-url').value;
            if(u.includes("firebaseio.com") || u.includes("firebasedatabase.app")) { 
                localStorage.setItem('fb_url', u); 
                location.reload(); 
            } else { alert("Lien invalide"); }
        }

        window.onload = () => {
            const url = localStorage.getItem('fb_url');
            if(url) {
                firebase.initializeApp({ databaseURL: url });
                db = firebase.database();
                syncFirebase();
            }
            const now = new Date();
            document.getElementById('ia-date').innerText = now.toLocaleString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            loadProfiles();
            setTimeout(() => {
                speak("Système Lemonfa Afussi activé. Justice Énergétique en cours. Veuillez signer pour accéder.");
            }, 800);
        };

        function auth(user) {
            let p = prompt(`CODE PIN ${user.toUpperCase()} :`);
            if(p === pins[user]) {
                authStates[user] = true;
                document.getElementById(`btn-${user === 'proprio' ? 'p' : 'l'}`).innerText = "SIGNÉ ✓";
                document.getElementById(`btn-${user === 'proprio' ? 'p' : 'l'}`).style.background = "#051";
                if(authStates.proprio && authStates.locat) unlock();
            } else { speak("Code erroné. Accès bloqué."); }
        }

        function unlock() {
            document.getElementById('lock-screen').style.transform = "translateY(-100%)";
            setTimeout(() => {
                document.getElementById('lock-screen').classList.add('hidden');
                document.getElementById('main-content').classList.remove('locked');
                speak("Accès autorisé. Contrôle du compteur en direct.");
            }, 700);
        }

        // FONCTION DE REDIMENSIONNEMENT 512x512
        function updateIdentity(user) {
            let p = prompt(`CONFIRMER PIN ${user.toUpperCase()} :`);
            if(p !== pins[user]) { speak("Erreur de PIN."); return; }
            
            let n = prompt("NOM A AFFICHER :");
            if(!n) return;
            
            localStorage.setItem(`name-${user}`, n);
            const fileInput = document.getElementById('fileIn');
            
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        // Utilisation du Canvas pour redimensionner en 512x512
                        const canvas = document.getElementById('canvas512');
                        const ctx = canvas.getContext('2d');
                        
                        // Dessiner l'image en couvrant le carré 512x512 (Crop center)
                        let ratio = Math.max(512 / img.width, 512 / img.height);
                        let nw = img.width * ratio;
                        let nh = img.height * ratio;
                        let cx = (512 - nw) / 2;
                        let cy = (512 - nh) / 2;
                        
                        ctx.clearRect(0, 0, 512, 512);
                        ctx.drawImage(img, cx, cy, nw, nh);
                        
                        // Sauvegarder en qualité optimisée
                        const optimizedData = canvas.toDataURL('image/jpeg', 0.8);
                        localStorage.setItem(`photo-${user}`, optimizedData);
                        loadProfiles();
                        speak("Profil mis à jour en haute résolution.");
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            };
            fileInput.click();
        }

        function loadProfiles() {
            ['proprio', 'locat'].forEach(u => {
                const pic = localStorage.getItem(`photo-${u}`);
                const nom = localStorage.getItem(`name-${u}`);
                if(pic) {
                    document.getElementById(`view-${u}`).src = pic;
                    if(u === 'proprio') document.getElementById('genie-photo').src = pic;
                }
                if(nom) {
                    document.getElementById(`name-${u}-label`).innerText = nom.toUpperCase();
                }
            });
        }

        function syncFirebase() {
            if(!db) return;
            db.ref('systeme').on('value', (s) => {
                const d = s.val() || { solde_kwh: 0 };
                document.getElementById('solde-kwh').innerText = d.solde_kwh.toFixed(2) + " kWh";
                document.getElementById('solde-argent').innerText = Math.floor(d.solde_kwh * 125) + " FCFA";
                if(d.alerte_vol) {
                    document.body.style.background = "#400";
                    speak("ALERTE VOL DÉTECTÉE SUR VOTRE COMPTEUR !");
                } else { document.body.style.background = "#020202"; }
            });
        }

        function validerPaiement() {
            if(!db) return alert("Configurez Firebase ⚙️");
            if(prompt("PIN PROPRIÉTAIRE :") === pins.proprio) {
                let m = prompt("MONTANT RECHARGE (FCFA) :");
                if(m && !isNaN(m)) {
                    db.ref('systeme').update({ recharge_temp: parseFloat(m)/125 });
                    speak("Recharge validée.");
                }
            } else { speak("Échec de sécurité."); }
        }
    </script>
</body>
</html>
