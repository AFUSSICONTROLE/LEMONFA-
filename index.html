<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SENTINELLE AFUSSI PRO V10.9.5</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root { --neon: #00ff88; --alert: #ff003c; --bg: #000; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    
    #video { position: fixed; width: 140px; height: 100px; bottom: 10px; left: 10px; border: 2px solid var(--neon); border-radius: 8px; z-index: 1; }
    #scan-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; flex-direction: column; align-items: center; justify-content: center; }
    #scan-view { width: 90%; height: 70%; border: 2px solid var(--neon); border-radius: 20px; object-fit: cover; }
    .scan-frame { position: absolute; border: 2px solid var(--neon); width: 220px; height: 280px; border-radius: 40px; box-shadow: 0 0 0 1000px rgba(0,0,0,0.8); pointer-events: none; }

    #clock { font-size: 4rem; font-weight: bold; color: var(--neon); text-shadow: 0 0 20px rgba(0,255,136,0.3); }
    #power-btn { margin-top: 30px; width: 150px; height: 150px; border-radius: 50%; background: var(--neon); color: #000; border: none; font-weight: bold; cursor: pointer; z-index: 20; box-shadow: 0 0 30px var(--neon); transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .status-off { background: var(--alert) !important; color: #fff !important; box-shadow: 0 0 30px var(--alert) !important; }

    #owner-display { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #600; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; animation: pulse 0.5s infinite alternate; }
    @keyframes pulse { from { background: #600; } to { background: #000; } }

    #admin-menu { display: none; position: fixed; bottom: 0; width: 100%; background: rgba(10,10,10,0.98); border-top: 3px solid var(--neon); padding: 20px; grid-template-columns: 1fr 1fr; gap: 15px; z-index: 100; box-sizing: border-box; border-radius: 20px 20px 0 0; }
    .btn-large { background: #1a1a1a; border: 2px solid var(--neon); color: white; padding: 15px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; font-weight: bold; cursor: pointer; }

    #config-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 6000; padding: 20px; box-sizing: border-box; overflow-y: auto; }
    input { width: 100%; padding: 10px; margin: 5px 0; background: #111; border: 1px solid var(--neon); color: white; border-radius: 5px; }
  </style>
</head>
<body onload="init()">

  <video id="video" autoplay muted playsinline></video>
  
  <div id="scan-overlay">
      <video id="scan-view" autoplay muted playsinline></video>
      <div class="scan-frame"></div>
      <h2 style="color: var(--neon); margin-top: 20px;">ENRÃ”LEMENT BIOMÃ‰TRIQUE</h2>
  </div>

  <div id="owner-display">
      <h1 style="color:white; text-align:center;">ðŸš¨ VOL EN COURS ðŸš¨</h1>
      <div id="owner-info" style="font-size: 1.4rem; text-align: center; color: yellow; padding: 20px; font-weight: bold;">ALERTE TRANSMISE Ã€ LA POLICE ET Ã€ MR AFUSSI</div>
  </div>

  <div id="clock">00:00:00</div>
  
  <button id="power-btn" onclick="secureAction(toggleSystem)">
    <span class="material-icons" style="font-size: 3rem;">shield</span>
    <span id="power-txt">ARMÃ‰</span>
  </button>

  <div style="position:fixed; bottom:0; width:100%; height:80px; z-index:15;" ondblclick="secureAction(toggleMenu)"></div>

  <div id="admin-menu">
    <button class="btn-large" onclick="secureAction(saveFace)" style="grid-column: span 2; border-color: gold; color: gold;"><span class="material-icons">face</span> SCAN MAÃŽTRE</button>
    <button class="btn-large" onclick="secureAction(showConfig)"><span class="material-icons">settings</span> RÃ‰GLAGES</button>
    <button class="btn-large" onclick="location.reload()"><span class="material-icons">refresh</span> REBOOT</button>
  </div>

  <div id="config-modal">
    <h2 style="color: var(--neon);">PARAMÃˆTRES PRO</h2>
    <input type="text" id="in-name" placeholder="Nom PropriÃ©taire">
    <input type="password" id="in-pin" placeholder="Code PIN">
    <input type="text" id="in-sid" placeholder="EmailJS Service ID">
    <input type="text" id="in-tmpl" placeholder="EmailJS Template ID">
    <input type="text" id="in-jsid" placeholder="EmailJS Public Key">
    <input type="text" id="in-token" placeholder="Telegram Bot Token">
    <input type="text" id="in-chat" placeholder="Telegram Chat ID">
    <button onclick="applyNewConfig()" style="width:100%; padding:15px; background:var(--neon); color:#000; margin-top:10px; border:none; border-radius:8px;">APPLIQUER</button>
    <button onclick="document.getElementById('config-modal').style.display='none'" style="width:100%; padding:10px; color:gray; background:none; border:none;">ANNULER</button>
  </div>

<script>
  let ownerDesc = null, isAlerte = false, alertInterval = null, gpsWatch = null;
  let cycleCount = 0;
  let systemActive = localStorage.getItem('active') !== 'false';
  const ESP = "http://192.168.4.1";

  function parler(t, mode = "normale") {
    window.speechSynthesis.cancel();
    const m = new SpeechSynthesisUtterance(t);
    m.lang = 'fr-FR';
    m.rate = (mode === "alerte") ? 1.1 : 0.95;
    window.speechSynthesis.speak(m);
  }

  async function init() {
    if(!localStorage.getItem('pin')) localStorage.setItem('pin', "1234");
    if(!localStorage.getItem('name')) localStorage.setItem('name', "Lemonfa Afussi");
    
    const MODEL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL);
    await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL);

    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
    document.getElementById('video').srcObject = stream;
    
    if(localStorage.getItem('desc')) ownerDesc = new Float32Array(Object.values(JSON.parse(localStorage.getItem('desc'))));
    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);
    setInterval(mainLoop, 1000);
    updateUI();
    parler("SystÃ¨me Sentinelle Afussi en ligne. Indicateurs au vert.");
  }

  async function mainLoop() {
    const v = document.getElementById('video');
    const det = await faceapi.detectSingleFace(v, new faceapi.TinyFaceDetectorOptions()).withFaceDescriptor();
    if(det && systemActive && ownerDesc) {
      const dist = faceapi.euclideanDistance(det.descriptor, ownerDesc);
      if(!isAlerte && dist > 0.45) triggerAlerte();
      else if(isAlerte && dist < 0.45) stopAlerte();
    }
  }

  function triggerAlerte() {
    if(isAlerte) return; isAlerte = true; cycleCount = 0;
    fetch(ESP + "/alarm").catch(()=>{});
    document.getElementById('owner-display').style.display = 'flex';
    
    parler("Alerte ! Passage des indicateurs au rouge. SirÃ¨ne activÃ©e.", "alerte");

    gpsWatch = navigator.geolocation.watchPosition((pos) => {
        const link = `http://maps.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
        envoyerNotifications(link);
    }, () => { 
        envoyerNotifications("âš ï¸ GPS BLOQUÃ‰ PAR LE VOLEUR !"); 
        parler("Alerte critique ! Tentative de sabotage GPS dÃ©tectÃ©e !");
    });

    alertInterval = setInterval(() => {
        cycleCount++;
        if(cycleCount < 10) {
            parler("Citoyens, veuillez prÃªter attention ! Ce tÃ©lÃ©phone appartient Ã  Monsieur " + localStorage.getItem('name') + ". Il est actuellement entre les mains d'un inconnu. S'il vous plaÃ®t, aidez-moi Ã  prÃ©venir le propriÃ©taire.", "alerte");
        } else {
            document.getElementById('owner-display').style.background = "#000";
            document.getElementById('owner-info').innerText = "TRACKING SILENCIEUX ACTIF";
            window.speechSynthesis.cancel();
        }
    }, 9000);
  }

  function stopAlerte() {
    isAlerte = false;
    clearInterval(alertInterval);
    if(gpsWatch) navigator.geolocation.clearWatch(gpsWatch);
    window.speechSynthesis.cancel();
    document.getElementById('owner-display').style.display = 'none';
    fetch(ESP + "/safe").catch(()=>{});
    parler("AccÃ¨s autorisÃ©. Passage des indicateurs au vert. Bonjour Monsieur " + localStorage.getItem('name'));
  }

  function envoyerNotifications(link) {
    const token = localStorage.getItem('token'), chat = localStorage.getItem('chat');
    if(token && chat) fetch(`https://api.telegram.org/bot${token}/sendMessage?chat_id=${chat}&text=ðŸš¨ POSITION MR AFUSSI : ${link}`);
    
    const sid = localStorage.getItem('sid'), tmpl = localStorage.getItem('tmpl'), jsid = localStorage.getItem('jsid');
    if(sid && tmpl && jsid) {
        emailjs.init(jsid);
        emailjs.send(sid, tmpl, { user_name: localStorage.getItem('name'), location_link: link });
    }
  }

  async function secureAction(cb) {
    let p = prompt("ðŸ”‘ CODE PIN :");
    if(p === localStorage.getItem('pin')) cb(); else alert("REFUSÃ‰.");
  }

  async function saveFace() {
    const overlay = document.getElementById('scan-overlay');
    overlay.style.display = 'flex';
    document.getElementById('scan-view').srcObject = document.getElementById('video').srcObject;
    parler("Analyse biomÃ©trique en cours. Restez immobile face Ã  l'objectif.");

    const checkFace = setInterval(async () => {
        const det = await faceapi.detectSingleFace(document.getElementById('scan-view'), new faceapi.TinyFaceDetectorOptions()).withFaceDescriptor();
        if(det) {
            clearInterval(checkFace);
            localStorage.setItem('desc', JSON.stringify(det.descriptor));
            parler("Analyse rÃ©ussie. PropriÃ©taire enregistrÃ©.");
            alert("âœ… BIOMÃ‰TRIE ENREGISTRÃ‰E.");
            location.reload();
        }
    }, 500);

    setTimeout(() => { 
        clearInterval(checkFace); 
        if(!localStorage.getItem('desc')) {
            alert("âŒ Ã‰CHEC : Trop long ou mauvaise lumiÃ¨re.");
            overlay.style.display = 'none';
        }
    }, 20000);
  }

  function toggleSystem() {
    systemActive = !systemActive; localStorage.setItem('active', systemActive);
    updateUI();
    parler(systemActive ? "Sentinelle armÃ©e. Indicateurs au vert." : "SystÃ¨me dÃ©sactivÃ©.");
    fetch(systemActive ? ESP + "/safe" : ESP + "/safe").catch(()=>{});
  }

  function updateUI() {
    const b = document.getElementById('power-btn');
    document.getElementById('power-txt').innerText = systemActive ? "ARMÃ‰" : "OFF";
    systemActive ? b.classList.remove('status-off') : b.classList.add('status-off');
  }

  function toggleMenu() {
    const m = document.getElementById('admin-menu');
    m.style.display = (m.style.display === 'grid') ? 'none' : 'grid';
  }

  function showConfig() {
    document.getElementById('config-modal').style.display = 'block';
    document.getElementById('in-name').value = localStorage.getItem('name');
    document.getElementById('in-pin').value = localStorage.getItem('pin');
    document.getElementById('in-sid').value = localStorage.getItem('sid');
    document.getElementById('in-tmpl').value = localStorage.getItem('tmpl');
    document.getElementById('in-jsid').value = localStorage.getItem('jsid');
    document.getElementById('in-token').value = localStorage.getItem('token');
    document.getElementById('in-chat').value = localStorage.getItem('chat');
  }

  function applyNewConfig() {
    localStorage.setItem('name', document.getElementById('in-name').value);
    localStorage.setItem('pin', document.getElementById('in-pin').value);
    localStorage.setItem('sid', document.getElementById('in-sid').value);
    localStorage.setItem('tmpl', document.getElementById('in-tmpl').value);
    localStorage.setItem('jsid', document.getElementById('in-jsid').value);
    localStorage.setItem('token', document.getElementById('in-token').value);
    localStorage.setItem('chat', document.getElementById('in-chat').value);
    location.reload();
  }
</script>
</body>
</html>
