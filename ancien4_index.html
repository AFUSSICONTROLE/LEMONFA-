<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SENTINELLE AFUSSI PRO V10.9.5</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">

  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root { --neon: #00ff88; --alert: #ff003c; --bg: #000; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    video { position: fixed; width: 1px; height: 1px; opacity: 0.01; } /* On garde ta m√©thode invisible */
    #app-logo { width: 85px; height: 85px; border-radius: 18px; margin-bottom: 10px; border: 2px solid var(--neon); box-shadow: 0 0 15px var(--neon); }
    #clock { font-size: 4.5rem; font-weight: bold; color: var(--neon); text-shadow: 0 0 20px rgba(0,255,136,0.3); }
    #power-btn { margin-top: 30px; width: 160px; height: 160px; border-radius: 50%; background: var(--neon); color: #000; border: none; font-weight: bold; z-index: 20; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 30px var(--neon); }
    .status-off { background: var(--alert) !important; color: #fff !important; box-shadow: 0 0 30px var(--alert) !important; }
    #owner-display { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #600; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; animation: pulse 0.5s infinite alternate; }
    @keyframes pulse { from { background: #600; } to { background: #000; } }
    #admin-menu { display: none; position: fixed; bottom: 0; width: 100%; background: rgba(10,10,10,0.98); border-top: 3px solid var(--neon); padding: 20px; grid-template-columns: 1fr 1fr; gap: 15px; z-index: 100; box-sizing: border-box; border-radius: 20px 20px 0 0; }
    .btn-large { background: #1a1a1a; border: 2px solid var(--neon); color: white; padding: 20px; border-radius: 15px; display: flex; flex-direction: column; align-items: center; font-weight: bold; cursor: pointer; }
    #config-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; padding: 30px; box-sizing: border-box; overflow-y: auto; }
    input, textarea { width: 100%; padding: 12px; margin: 6px 0; background: #111; border: 1px solid var(--neon); color: white; border-radius: 8px; }
  </style>
</head>
<body onload="init()">

  <video id="video" autoplay muted playsinline></video>
  <img id="app-logo" src="https://cdn-icons-png.flaticon.com/512/508/508281.png">

  <div id="owner-display">
      <h1 style="color:white; text-align:center;">üö® INTRUSION D√âTECT√âE üö®</h1>
      <div id="owner-info" style="font-size: 1.5rem; text-align: center; color: yellow;">ALERTE TRANSMISSE</div>
  </div>

  <div id="clock">00:00:00</div>
  
  <button id="power-btn" onclick="secureAction(toggleSystem)">
    <span class="material-icons" style="font-size: 3.5rem;">shield</span>
    <span id="power-txt">ARM√â</span>
  </button>

  <div style="position:fixed; bottom:0; width:100%; height:100px; z-index:15;" ondblclick="secureAction(toggleMenu)"></div>

  <div id="admin-menu">
    <button class="btn-large" onclick="secureAction(saveFace)" style="grid-column: span 2; border-color: gold; color: gold;">
        <span class="material-icons">face</span> SCAN RAPIDE (500ms)
    </button>
    <button class="btn-large" onclick="secureAction(showConfig)">
        <span class="material-icons">settings</span> CONFIGURATION
    </button>
    <button class="btn-large" onclick="location.reload()">
        <span class="material-icons">refresh</span> RED√âMARRER
    </button>
  </div>

  <div id="config-modal">
    <h2 style="color: var(--neon);">‚öôÔ∏è R√âGLAGES</h2>
    <input type="text" id="in-name" placeholder="Nom">
    <input type="password" id="in-pin" placeholder="Code PIN">
    <input type="text" id="in-token" placeholder="Telegram Token">
    <input type="text" id="in-chat" placeholder="Telegram Chat ID">
    <button onclick="applyNewConfig()" style="width:100%; padding:20px; background:var(--neon); color:#000; font-weight:bold; border-radius:10px;">APPLIQUER</button>
    <button onclick="document.getElementById('config-modal').style.display='none'" style="width:100%; padding:10px; color:#555;">ANNULER</button>
  </div>

<script>
  // Enregistrement imm√©diat pour l'ic√¥ne
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
  }

  let ownerDesc = null, isAlerte = false, alertInterval = null;
  let systemActive = localStorage.getItem('active') !== 'false';
  const ESP = "http://192.168.4.1";

  function parler(t) {
    window.speechSynthesis.cancel();
    const m = new SpeechSynthesisUtterance(t);
    m.lang = 'fr-FR';
    window.speechSynthesis.speak(m);
  }

  async function init() {
    if(!localStorage.getItem('pin')) localStorage.setItem('pin', "1234");
    if(!localStorage.getItem('name')) localStorage.setItem('name', "Monsieur Afussi");
    
    const MODEL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL);
    await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL);

    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
    document.getElementById('video').srcObject = stream;
    
    if(localStorage.getItem('desc')) ownerDesc = new Float32Array(Object.values(JSON.parse(localStorage.getItem('desc'))));
    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);
    setInterval(mainLoop, 1000);
    updateUI();
    parler("Syst√®me Sentinelle en ligne. Bonjour " + localStorage.getItem('name'));
  }

  async function mainLoop() {
    const v = document.getElementById('video');
    const det = await faceapi.detectSingleFace(v, new faceapi.TinyFaceDetectorOptions()).withFaceDescriptor();
    if(det && systemActive && ownerDesc) {
      const dist = faceapi.euclideanDistance(det.descriptor, ownerDesc);
      if(!isAlerte && dist > 0.45) triggerAlerte();
      else if(isAlerte && dist < 0.45) stopAlerte();
    }
  }

  function triggerAlerte() {
    if(isAlerte) return; isAlerte = true;
    fetch(ESP + "/alarm").catch(()=>{});
    document.getElementById('owner-display').style.display = 'flex';
    parler("Alerte ! Intrusion d√©tect√©e ! Passage des indicateurs au rouge.");
  }

  function stopAlerte() {
    isAlerte = false;
    document.getElementById('owner-display').style.display = 'none';
    fetch(ESP + "/safe").catch(()=>{});
    parler("Identit√© confirm√©e. Indicateurs au vert.");
  }

  async function secureAction(cb) {
    let p = prompt("üîê CODE PIN REQUIS :");
    if(p === localStorage.getItem('pin')) cb(); else alert("Acc√®s refus√©.");
  }

  function saveFace() {
    parler("Analyse biom√©trique lanc√©e. Regardez l'√©cran.");
    const check = setInterval(async () => {
      const det = await faceapi.detectSingleFace(document.getElementById('video'), new faceapi.TinyFaceDetectorOptions()).withFaceDescriptor();
      if(det) {
        clearInterval(check);
        localStorage.setItem('desc', JSON.stringify(det.descriptor));
        parler("Enregistrement r√©ussi.");
        alert("BIOM√âTRIE SYNCHRONIS√âE.");
        location.reload();
      }
    }, 500); // Scan toutes les 500ms
  }

  function toggleSystem() {
    systemActive = !systemActive; localStorage.setItem('active', systemActive);
    updateUI();
    parler(systemActive ? "Syst√®me arm√©." : "Syst√®me d√©sactiv√©.");
  }

  function updateUI() {
    const b = document.getElementById('power-btn');
    document.getElementById('power-txt').innerText = systemActive ? "ARM√â" : "OFF";
    systemActive ? b.classList.remove('status-off') : b.classList.add('status-off');
  }

  function toggleMenu() {
    const m = document.getElementById('admin-menu');
    m.style.display = (m.style.display === 'grid') ? 'none' : 'grid';
  }

  function showConfig() {
    document.getElementById('config-modal').style.display = 'block';
    document.getElementById('in-name').value = localStorage.getItem('name');
    document.getElementById('in-pin').value = localStorage.getItem('pin');
  }

  function applyNewConfig() {
    localStorage.setItem('name', document.getElementById('in-name').value);
    localStorage.setItem('pin', document.getElementById('in-pin').value);
    location.reload();
  }
</script>
</body>
</html>
